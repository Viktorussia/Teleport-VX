#!/usr/bin/env ash
set -e

ROOT="$HOME/teleport-vx"

case "$1" in
  status)
    echo "Teleport VX — Neon Aurora"
    LOCALTIME=$(TZ=GMT-10 date "+%Y-%m-%d %H:%M:%S"); echo "[OK] Local Time (Vladivostok): $LOCALTIME"
    printf "[OK] Kernel: active (ash/busybox)\n"
    awk '/MemTotal:/{t=$2}/MemAvailable:/{a=$2}END{if(t>0){u=t-a;p=int(u*100/t);printf("[OK] Memory: %d%% used (%d / %d kB)\n",p,u,t)}else{print "[WARN] Memory info unavailable"}}' /proc/meminfo
    LOAD=$(uptime | awk -F'load average: ' '{print $2}' | cut -d, -f1-3)
    printf "[OK] CPU Load: %s\n" "$LOAD"
    UP=$(uptime | awk -F'up ' '{print $2}' | awk -F',' '{print $1}')
    printf "[OK] Uptime: %s\n" "$UP"
    ;;

  version)
    . "$ROOT/config/system.cfg"
    echo "$VX_VERSION ($VX_CODENAME) — $VX_DATE"
    ;;

  doctor)
    "$ROOT/tools/doctor.sh"
    ;;

  net)
    shift
    "$ROOT/core/net.sh" "$@"
    ;;

  ui)
    "$ROOT/ui/menu.sh"
    ;;

  ai)
    "$ROOT/ai/assistant.sh"
    ;;

  update)
    (cd "$ROOT" && git pull --rebase)
    ;;

  sync)
    (cd "$ROOT" && git add . && git commit -m "AutoSync: $(date +%Y-%m-%d_%H:%M:%S)" || true && git push)
    ;;

  *)
    cat <<HLP
Teleport VX CLI
Usage:
  vx status        — состояние системы
  vx version       — версия ОС
  vx doctor        — диагностика
  vx net ...       — сетевые утилиты
  vx ui            — текстовое меню
  vx ai            — (заглушка) ИИ-модуль
  vx update        — подтянуть изменения из GitHub
  vx sync          — закоммитить и запушить изменения
HLP
    ;;
esac
